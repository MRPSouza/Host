# Verifica se mod_rewrite está disponível
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # Redireciona www para non-www (opcional)
    RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
    RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

    # Não redireciona arquivos e diretórios existentes
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d

    # Redireciona todas as requisições para index.php
    RewriteRule ^(.*)$ index.php [QSA,L]
</IfModule>

# Força HTTPS
# RewriteEngine On
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Adiciona headers de segurança
<IfModule mod_headers.c>
    # Header set X-XSS-Protection "1; mode=block"
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    # Header set X-Content-Type-Options "nosniff"
    # Header set X-Frame-Options "SAMEORIGIN"
    # Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# # Se mod_rewrite não estiver disponível
# <IfModule !mod_rewrite.c>
#     ErrorDocument 500 "Mod_rewrite não está ativado. Por favor, ative-o no Apache."
# </IfModule>

# Content Security Policy (CSP)
# <IfModule mod_headers.c>
#     Header set Content-Security-Policy "
#         # Fontes de conteúdo padrão
#         default-src 'self';

#         # Scripts permitidos
#         script-src 'self' 
#             'unsafe-inline' 
#             'unsafe-eval' 
#             https://cdn.jsdelivr.net 
#             https://code.jquery.com 
#             https://cdnjs.cloudflare.com;

#         # Estilos permitidos
#         style-src 'self' 
#             'unsafe-inline' 
#             https://cdn.jsdelivr.net 
#             https://fonts.googleapis.com;

#         # Fontes permitidas
#         font-src 'self' 
#             https://fonts.gstatic.com 
#             https://cdn.jsdelivr.net;

#         # Imagens permitidas
#         img-src 'self' 
#             data: 
#             https: 
#             blob:;

#         # Conexões permitidas
#         connect-src 'self' 
#             https://api.exemplo.com;

#         # Frames permitidos
#         frame-src 'self' 
#             https://www.google.com 
#             https://www.youtube.com;

#         # Objetos permitidos
#         object-src 'none';

#         # Manifesto permitido
#         manifest-src 'self';

#         # Base URI
#         base-uri 'self';

#         # Form actions
#         form-action 'self';

#         # Frame ancestors
#         frame-ancestors 'self';

#         # Upgrade insecure requests
#         upgrade-insecure-requests;
#     "

#     # Outras headers de segurança importantes
#     Header set X-Content-Type-Options "nosniff"
#     Header set X-Frame-Options "SAMEORIGIN"
#     Header set X-XSS-Protection "1; mode=block"
#     Header set Referrer-Policy "strict-origin-when-cross-origin"
#     Header set Permissions-Policy "geolocation=(), microphone=(), camera=()"
# </IfModule>

# Previne listagem de diretórios
Options -Indexes

# Habilita o mod_rewrite
RewriteEngine On

# Se o arquivo ou diretório não existe
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# Redireciona para o index.php
RewriteRule ^(.*)$ index.php?url=$1 [QSA,L]

# Tratamento de erros para arquivos estáticos
<FilesMatch "\.(ico|png|jpg|jpeg|gif|webp|svg|css|js|woff|woff2|ttf|eot)$">
    # Se o arquivo não existe, retorna 404 silenciosamente
    ErrorDocument 404 "File not found"
    # Previne log de erro no PHP
    php_flag log_errors off
</FilesMatch>

# Cache para arquivos estáticos
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Favicon
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    
    # Imagens
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    
    # Fontes
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    
    # CSS e JavaScript
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
</IfModule>